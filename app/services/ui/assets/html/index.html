<!DOCTYPE html>
<html>
    <head>
        <title>Testing Metamask Wallet</title>
        <script src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script>
            function currentDateTime() {
                const dt = new Date();
                
                const year    = dt.getUTCFullYear();
                const month   = String(dt.getUTCMonth() + 1).padStart(2, '0'); // Month (0-indexed)
                const day     = String(dt.getUTCDate()).padStart(2, '0');
                const hours   = String(dt.getUTCHours()).padStart(2, '0');
                const minutes = String(dt.getUTCMinutes()).padStart(2, '0');
                const seconds = String(dt.getUTCSeconds()).padStart(2, '0');

                return `${year}${month}${day}${hours}${minutes}${seconds}`;
            }
        </script>
        <script>
            // Setting some ajax specific global settings.
            $.ajaxSetup({
                contentType: "application/json; charset=utf-8",
            });

            // handleAjaxError is a helper function for handling the response from any
            // ajax request that is made.
            function handleAjaxError(jqXHR, exception) {
                var msg = '';

                switch (jqXHR.status) {
                case 0:
                    msg = 'Not connected, verify network.';
                case 404:
                    msg = 'Requested page not found. [404]';
                case 500:
                    msg = 'Internal Server Error [500].';
                default:
                    switch (exception) {
                    case "parsererror":
                        msg = 'Requested JSON parse failed.';
                    case "timeout":
                        msg = 'Time out error.';
                    case "abort":
                        msg = 'Ajax request aborted.';
                    default:
                        const o = JSON.parse(jqXHR.responseText);
                        msg = o.error;
                    }
                }

                console.log(msg);
            }
        </script>
        <script>
            const sdk = new MetaMaskSDK.MetaMaskSDK({
              dappMetadata: {
                name: "Pure JS example",
                url: window.location.host,
              },
              logging: {
                sdk: false,
              }
            });
        </script>
        <script>
            function hexer(input) {
                const utf8 = toUTF8Array(input);
                const hex = utf8.map(n => n.toString(16));
                return '0x' + hex.join('');
            }

            // From https://stackoverflow.com/a/18729931
            function toUTF8Array(str) {
                var utf8 = [];
                for (var i=0; i < str.length; i++) {
                    var charcode = str.charCodeAt(i);
                    if (charcode < 0x80) utf8.push(charcode);
                    else if (charcode < 0x800) {
                        utf8.push(0xc0 | (charcode >> 6),
                                0x80 | (charcode & 0x3f));
                    }
                    else if (charcode < 0xd800 || charcode >= 0xe000) {
                        utf8.push(0xe0 | (charcode >> 12),
                                0x80 | ((charcode>>6) & 0x3f),
                                0x80 | (charcode & 0x3f));
                    }
                    // surrogate pair
                    else {
                        i++;
                        // UTF-16 encodes 0x10000-0x10FFFF by
                        // subtracting 0x10000 and splitting the
                        // 20 bits of 0x0-0xFFFFF into two halves
                        charcode = 0x10000 + (((charcode & 0x3ff)<<10)
                                | (str.charCodeAt(i) & 0x3ff));
                        utf8.push(0xf0 | (charcode >>18),
                                0x80 | ((charcode>>12) & 0x3f),
                                0x80 | ((charcode>>6) & 0x3f),
                                0x80 | (charcode & 0x3f));
                    }
                }
                return utf8;
            }
        </script>
        <script>
            var chainId;

            function config() {
                $.ajax({
                    type: "get",
                    url: "http://0.0.0.0:3000/v1/game/config",
                    success: function (res) {
                        console.log(res);
                        chainId = res.chainId;
                        $("#config").text(JSON.stringify(res));
                    },
                    error: function (jqXHR, exception) {
                        console.log(exception);
                        $("#config").text(exception);
                    },
                });
            }

            function connect() {
              ethereum
                .request({
                  method: 'eth_requestAccounts',
                  params: [],
                })
                .then((res) => {
                    console.log('request accounts', res);
                    $("#connect").text(JSON.stringify(res));
                })
                .catch((e) => {
                    console.log('request accounts ERR', e)
                    $("#connect").text(e);
                });
            }

            function accounts() {
              ethereum
                .request({
                  method: 'eth_accounts',
                  params: [],
                })
                .then((res) => {
                    console.log('accounts', res);
                    $("#sign").text(JSON.stringify(res));
                })
                .catch((e) => {
                    console.log('accounts ERR', e)
                    $("#sign").text(e);
                });
            }
            
            var signed;
            var dateTime;
            
            function personalSign() {
              dateTime = currentDateTime();
              const data = `{"address":"0x6327a38415c53ffb36c11db55ea74cc9cb4976fd","chainId":${chainId},"dateTime":"${dateTime}"}`;

              ethereum
                .request({
                    method: 'personal_sign',
                    params: [
                        hexer(data),
                        "0x6327a38415c53ffb36c11db55ea74cc9cb4976fd"
                    ],
                })
                .then((res) => {
                    signed=res;
                    console.log('personal sign', res);
                    $("#psign").text(JSON.stringify(res) + " " + data);
                })
                .catch((e) => {
                    console.log('personal sign ERR', e)
                    $("#psign").text(e + " " + data);
                });
            }

            function connectGE() {
                const data = `{"address":"0x6327a38415c53ffb36c11db55ea74cc9cb4976fd","chainId":${chainId},"dateTime":"${dateTime}","sig":"${signed}"}`;

                $.ajax({
                    type: "post",
                    url: "http://0.0.0.0:3000/v1/game/connect",
                    data: data,
                    success: function (res) {
                        console.log(res);
                        $("#cge").text(JSON.stringify(res));
                    },
                    error: function (jqXHR, exception) {
                        console.log(exception);
                        $("#cge").text(exception + " " + data);
                    },
                });
            }
    </script>
    </head>
    <body>
        <h1>Testing Metamask Wallet 4</h1>
        <button onclick="config()">Config</button>
        <button onclick="connect()">Connect</button>
        <button onclick="accounts()">Accounts</button>
        <button onclick="personalSign()">Sign Data</button>
        <button onclick="connectGE()">Conn GE</button>
        <h2></h2>
        <div id="config"></div>
        <div id="connect"></div>
        <div id="sign"></div>
        <div id="psign"></div>
        <div id="cge"></div>
    </body>
</html>